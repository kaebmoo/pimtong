{% extends "base.html" %}

{% block header %}
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 id="pageTitle" class="text-3xl font-bold text-gray-800">{{ t('job_header', lang) }}</h1>
    {% if user.role in ['admin', 'staff'] %}
    <button onclick="openJobModal()"
        class="bg-primary hover:bg-sky-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">
        <i class="fas fa-plus mr-2"></i> {{ t('btn_add_job', lang) }}
    </button>
    {% endif %}
</div>

<div class="bg-white shadow rounded-lg overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                    t('col_status', lang) }}</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                    t('col_title', lang) }}</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                    t('col_customer', lang) }}</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                    t('col_schedule', lang) }}</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                    t('col_type', lang) }}</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                    t('col_actions', lang) }}</th>
            </tr>
        </thead>
        <tbody id="jobTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Populated by JS -->
        </tbody>
    </table>
</div>

<!-- Modal -->
<div id="jobModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" x-show="open">
    <div class="relative top-20 mx-auto p-5 border w-[800px] shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="modalTitle">New Job</h3>
            <div class="mt-4">
                <form id="jobForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="jobId">

                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="title">{{ t('label_title', lang)
                            }}</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="title" type="text" required>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="description">{{
                            t('label_description', lang) }}</label>
                        <textarea
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="description"></textarea>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="projectId">{{ t('label_project',
                            lang) }}
                            {{ t('label_optional', lang) }}</label>
                        <select
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="projectId">
                            <option value="">No Project</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="jobType">{{ t('label_type', lang)
                            }}</label>
                        <select
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="jobType">
                            <option value="service">Service</option>
                            <option value="sales">Sales</option>
                            <option value="project">Project</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="status">{{ t('label_status',
                            lang) }}</label>
                        <select
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="status">
                            <option value="pending">Pending</option>
                            <option value="assigned">Assigned</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="customerName">{{
                            t('label_customer_name', lang) }}</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="customerName" type="text" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="customerPhone">{{
                            t('label_phone', lang) }}</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="customerPhone" type="text" required>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="technicianIds">{{
                            t('label_assign', lang) }}</label>
                        <input type="text" id="techSearch" placeholder="Search technicians..."
                            class="mb-2 shadow appearance-none border rounded w-full py-1 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                        <select multiple
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24"
                            id="technicianIds">
                            <!-- Populated by JS -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple.</p>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('label_location', lang)
                            }}</label>
                        <div id="map" class="h-64 w-full rounded border shadow-sm z-0"></div>
                        <input type="hidden" id="locationLat">
                        <input type="hidden" id="locationLong">
                        <div class="flex gap-2 mt-2 text-sm text-gray-600">
                            <input id="displayLat" class="bg-gray-100 border rounded px-2" placeholder="Lat" readonly>
                            <input id="displayLong" class="bg-gray-100 border rounded px-2" placeholder="Long" readonly>
                        </div>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="customerAddress">{{
                            t('label_address', lang) }}</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="customerAddress" type="text" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="scheduledDate">{{ t('label_date',
                            lang) }}</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="scheduledDate" type="date" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="scheduledTime">{{ t('label_time',
                            lang) }}
                            {{ t('label_optional', lang) }}</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="scheduledTime" type="time">
                    </div>

                    <div class="col-span-2 flex items-center justify-end mt-4 gap-2">
                        <button type="button" onclick="closeJobModal()"
                            class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            {{ t('btn_cancel', lang) }}
                        </button>
                        <button type="submit"
                            class="bg-primary hover:bg-sky-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            {{ t('btn_save', lang) }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let marker;
    let datePicker;
    const currentUserRole = "{{ user.role }}".toLowerCase();
    const currentUserId = {{ user.id }};

    // Translation object for JS
    const translations = {
        unassigned: "{{ t('label_unassigned', lang) }}",
        unknown: "{{ t('label_unassigned', lang) }}",
        edit: "{{ t('btn_edit', lang) }}",
        delete: "{{ t('btn_delete', lang) }}",
        nav: "Nav",
        status: {
            pending: "{{ t('status_pending', lang) }}",
            assigned: "{{ t('status_assigned', lang) }}",
            in_progress: "{{ t('status_in_progress', lang) }}",
            completed: "{{ t('status_completed', lang) }}",
            cancelled: "{{ t('status_cancelled', lang) }}",
            on_hold: "{{ t('status_on_hold', lang) }}",
        },
        modalNew: "{{ t('modal_new_job', lang) }}",
        modalEdit: "{{ t('modal_edit_job', lang) }}",
        confirm: "{{ t('confirm_delete_job', lang) }}",
        errDelete: "{{ t('err_delete_job', lang) }}",
        errApp: "{{ t('err_app_error', lang) }}",
        err: "{{ t('err_error', lang) }}"
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Init Flatpickr
        const currentLang = "{{ lang }}";
        datePicker = flatpickr("#scheduledDate", {
            altInput: true,
            altFormat: "d/m/Y",
            dateFormat: "Y-m-d",
            locale: currentLang === 'th' ? "th" : "default",
            defaultDate: new Date()
        });

        loadJobs();
        loadTechnicians();
        loadProjects();
    });

    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    const statusColors = {
        'pending': 'bg-red-100 text-red-800',
        'assigned': 'bg-blue-100 text-blue-800',
        'in_progress': 'bg-yellow-100 text-yellow-800',
        'completed': 'bg-green-100 text-green-800',
        'cancelled': 'bg-gray-100 text-gray-800'
    };

    async function loadProjects() {
        try {
            const response = await fetch('/api/projects/');
            if (response.ok) {
                const projects = await response.json();
                const select = document.getElementById('projectId');
                select.innerHTML = '<option value="">No Project</option>';
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.text = p.name;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error(e); }
    }

    async function loadTechnicians() {
        const response = await fetch('/api/users/?limit=100'); // Filter by role in real app
        const users = await response.json();
        const select = document.getElementById('technicianIds');
        select.innerHTML = '';
        users.filter(u => u.role === 'technician' || u.role === 'admin').forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            // Use nice display for tech
            option.text = user.full_name + (user.role === 'admin' ? ' (Admin)' : '');
            option.dataset.search = option.text.toLowerCase(); // Cache for search
            select.appendChild(option);
        });

        // Filter Logic
        document.getElementById('techSearch').addEventListener('input', function (e) {
            const term = e.target.value.toLowerCase();
            const options = select.options;
            for (let i = 0; i < options.length; i++) {
                const txt = options[i].dataset.search;
                if (txt.includes(term)) {
                    options[i].style.display = '';
                } else {
                    options[i].style.display = 'none';
                }
            }
        });
    }

    let currentJobs = [];

    async function loadJobs() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id');
            const search = urlParams.get('search');

            let url = '/api/jobs/';
            let params = [];

            if (projectId) params.push(`project_id=${projectId}`);
            if (search) params.push(`search=${search}`);

            // Anti-cache
            params.push(`t=${Date.now()}`);

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            // Sync search bar if present
            const searchInput = document.getElementById('globalSearch');
            if (searchInput && search) searchInput.value = search;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            const jobs = await response.json();
            currentJobs = jobs; // Store globally

            const tbody = document.getElementById('jobTableBody');
            tbody.innerHTML = '';

            // Update Title if filtering
            if (projectId) {
                try {
                    const projResp = await fetch(`/api/projects/${projectId}`);
                    if (projResp.ok) {
                        const project = await projResp.json();
                        const titleEl = document.getElementById('pageTitle');
                        if (titleEl) {
                            titleEl.innerHTML = `Work Orders <span class="text-gray-500 text-xl font-normal">/ ${project.name}</span>`;
                        }
                    }
                } catch (e) { console.error("Failed to load project info", e); }
            }

            jobs.forEach((job, index) => {
                const tr = document.createElement('tr');
                const statusClass = statusColors[job.status] || 'bg-gray-100 text-gray-800';

                // Format assignments
                let assignedTo = '<span class="text-gray-400 italic">Unassigned</span>';
                if (job.assignments && job.assignments.length > 0) {
                    assignedTo = job.assignments.map(a =>
                        `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 mr-1 mb-1">
                            ${a.technician ? a.technician.full_name : 'Unknown User'}
                         </span>`
                    ).join('');
                }

                // Navigate Button (if lat/long exists)
                // Usng editJob(index) to avoid JSON stringify issues
                let actionButtons = '';

                // Check if user is assigned
                const isAssigned = job.assignments && job.assignments.some(a => a.technician && a.technician.id === currentUserId);
                const canEdit = (currentUserRole === 'admin' || currentUserRole === 'staff' || isAssigned);

                if (canEdit) {
                    actionButtons += `<button onclick='editJob(${index})' class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>`;
                }

                if (currentUserRole === 'admin') {
                    actionButtons += `<button onclick="deleteJob(${job.id})" class="text-red-600 hover:text-red-900">Delete</button>`;
                }
                if (job.location_lat && job.location_long) {
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${job.location_lat},${job.location_long}`;
                    // Nav button prepended
                    actionButtons = `
                        <a href="${navUrl}" target="_blank" class="text-green-600 hover:text-green-900 mr-2 text-xs border border-green-200 bg-green-50 rounded px-1 py-0.5"><i class="fas fa-map-marked-alt"></i> Nav</a>
                        ${actionButtons}
                    `;
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full uppercase ${statusClass}">
                            ${job.status.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${job.title}</div>
                        <div class="text-xs mt-1">${assignedTo}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${job.customer_name}</div>
                        <div class="text-xs text-gray-500">${job.customer_phone}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div>${formatDate(job.scheduled_date)}</div>
                        <div class="text-xs">${job.scheduled_time || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">
                        ${job.job_type}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Load Jobs Error:", error);
            // Alert user so they report it
            alert(translations.errApp + ": " + error.message);
        }
    }

    const modal = document.getElementById('jobModal');
    const form = document.getElementById('jobForm');

    function initMap(lat = 13.7563, long = 100.5018) { // Default Bangkok
        if (map) {
            map.off();
            map.remove();
        }

        map = L.map('map').setView([lat, long], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Geocoder Search Control
        L.Control.geocoder({
            defaultMarkGeocode: false
        })
            .on('markgeocode', function (e) {
                var bbox = e.geocode.bbox;
                var poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]).addTo(map);
                map.fitBounds(poly.getBounds());

                setPin(e.geocode.center.lat, e.geocode.center.lng);
            })
            .addTo(map);

        // Add click handler
        map.on('click', function (e) {
            setPin(e.latlng.lat, e.latlng.lng);
        });

        // Set initial marker if provided
        if (document.getElementById('locationLat').value) {
            setPin(lat, long);
        }
    }

    function setPin(lat, lng) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker([lat, lng]).addTo(map);
        document.getElementById('locationLat').value = lat;
        document.getElementById('locationLong').value = lng;
        document.getElementById('displayLat').value = lat.toFixed(6);
        document.getElementById('displayLong').value = lng.toFixed(6);
    }

    // Fix map rendering issue in hidden modal
    function resizeMap() {
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 200);
    }

    function openJobModal() {
        document.getElementById('modalTitle').innerText = translations.modalNew;
        form.reset();
        document.getElementById('jobId').value = '';
        document.getElementById('projectId').value = '';
        document.getElementById('projectId').value = '';
        // Set default date to today
        if (datePicker) datePicker.setDate(new Date());

        // Reset select
        const select = document.getElementById('technicianIds');
        for (let i = 0; i < select.options.length; i++) select.options[i].selected = false;

        modal.classList.remove('hidden');
        initMap(); // Default map
        resizeMap();

        // Ensure fields enabled
        if (currentUserRole !== 'technician') enableAllFields();
    }

    function closeJobModal() {
        modal.classList.add('hidden');
    }

    function editJob(index) {
        const job = currentJobs[index];
        if (!job) return;

        document.getElementById('modalTitle').innerText = translations.modalEdit;
        document.getElementById('jobId').value = job.id;
        document.getElementById('title').value = job.title;
        document.getElementById('description').value = job.description || '';
        document.getElementById('jobType').value = job.job_type;
        document.getElementById('status').value = job.status;
        document.getElementById('customerName').value = job.customer_name;
        document.getElementById('customerPhone').value = job.customer_phone;
        document.getElementById('customerAddress').value = job.customer_address;
        if (datePicker) datePicker.setDate(job.scheduled_date);
        document.getElementById('scheduledTime').value = job.scheduled_time || '';
        document.getElementById('projectId').value = job.project_id || '';

        // Map
        document.getElementById('locationLat').value = job.location_lat || '';
        document.getElementById('locationLong').value = job.location_long || '';
        document.getElementById('displayLat').value = job.location_lat || '';
        document.getElementById('displayLong').value = job.location_long || '';

        // Assignments
        const select = document.getElementById('technicianIds');
        const assignedIds = job.assignments ? job.assignments
            .map(a => a.technician ? a.technician.id : null)
            .filter(id => id !== null) : [];

        for (let i = 0; i < select.options.length; i++) {
            select.options[i].selected = assignedIds.includes(parseInt(select.options[i].value));
        }

        modal.classList.remove('hidden');

        // Initialize map with job location or default
        const lat = job.location_lat ? parseFloat(job.location_lat) : 13.7563;
        const lng = job.location_long ? parseFloat(job.location_long) : 100.5018;
        initMap(lat, lng);
        resizeMap();

        // RBAC: Disable fields for Technicians
        if (currentUserRole === 'technician') {
            disableFieldsForTechnician();
        } else {
            enableAllFields();
        }
    }

    function disableFieldsForTechnician() {
        // Disable all inputs except Status
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.id !== 'status' && input.id !== 'jobId' && input.id !== 'locationLat' && input.id !== 'locationLong') {
                input.disabled = true;
                input.classList.add('bg-gray-100');
            }
        });

        // Specifically Hide Assignment Section
        const techSection = document.getElementById('technicianIds').closest('.col-span-2');
        if (techSection) techSection.style.display = 'none';

        // Disable Map Interaction (Overlay)
        const mapDiv = document.getElementById('map');
        mapDiv.style.pointerEvents = 'none';
        mapDiv.style.opacity = '0.7';
    }

    function enableAllFields() {
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.disabled = false;
            input.classList.remove('bg-gray-100');
        });

        // Show Assignment Section
        const techSection = document.getElementById('technicianIds').closest('.col-span-2');
        if (techSection) techSection.style.display = 'block';

        // Enable Map
        const mapDiv = document.getElementById('map');
        mapDiv.style.pointerEvents = 'auto';
        mapDiv.style.opacity = '1';
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const jobId = document.getElementById('jobId').value;
        const isEdit = !!jobId;

        // Get selected technicians (if visible)
        let technicianIds = [];
        const select = document.getElementById('technicianIds');
        if (!select.disabled && select.offsetParent !== null) {
            technicianIds = Array.from(select.selectedOptions).map(option => parseInt(option.value));
        }

        const data = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            job_type: document.getElementById('jobType').value,
            status: document.getElementById('status').value,
            customer_name: document.getElementById('customerName').value,
            customer_phone: document.getElementById('customerPhone').value,
            customer_address: document.getElementById('customerAddress').value,
            location_lat: document.getElementById('locationLat').value,
            location_long: document.getElementById('locationLong').value,
            scheduled_date: document.getElementById('scheduledDate').value,
            scheduled_time: document.getElementById('scheduledTime').value,
            project_id: document.getElementById('projectId').value ? parseInt(document.getElementById('projectId').value) : null,
            technician_ids: technicianIds
        };

        // For Technician: Only send Status
        if (currentUserRole === 'technician') {
            if (currentUserRole === 'technician') {
                delete data.technician_ids;
                // Also ensure other fields don't accidentally unwanted overwrite if logic changes, but current trust is OK.
            }
        }

        const url = isEdit ? `/api/jobs/${jobId}` : '/api/jobs/';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            closeJobModal();
            loadJobs();
        } else {
            const err = await response.json();
            alert(translations.err + ": " + err.detail);
        }
    });

    async function deleteJob(jobId) {
        if (!confirm(translations.confirm)) return;
        const response = await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
        if (response.ok) {
            loadJobs();
        } else {
            alert(translations.errDelete);
        }
    }
</script>
{% endblock %}