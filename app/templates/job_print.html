<!DOCTYPE html>
<html lang="{{ lang }}">

<head>
    <meta charset="UTF-8">
    <title>{{ t('job_header', lang) }} #{{ job.id }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        @media print {
            .no-print {
                display: none;
            }

            body {
                font-size: 12pt;
            }
        }
    </style>
</head>

<body class="bg-gray-100 p-8 print:p-0 print:bg-white">

    <div class="max-w-4xl mx-auto bg-white p-8 shadow-md print:shadow-none">

        <!-- Header -->
        <div class="flex justify-between items-start border-b-2 border-gray-800 pb-4 mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">JOB SHEET</h1>
                <p class="text-sm text-gray-500">Document No: JOB-{{ '%04d' % job.id }}</p>
                <p class="text-sm text-gray-500">Date: {{ job.created_at.strftime('%d/%m/%Y') }}</p>
            </div>
            <div class="text-right">
                <h2 class="text-xl font-bold text-primary">Pimtong WM</h2>
                <p class="text-sm">Service & Support Team</p>
                <div
                    class="mt-2 inline-block px-3 py-1 rounded border border-gray-300 font-bold uppercase {{ 'bg-green-100 text-green-800' if job.status == 'completed' else 'bg-gray-100' }}">
                    {{ t('status_' + job.status, lang) }}
                </div>
            </div>
        </div>

        <!-- Job Info -->
        <div class="mb-6">
            <h3 class="text-lg font-bold border-b border-gray-300 mb-2 uppercase">{{ t('tab_details', lang) }}</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <span class="block text-xs font-bold text-gray-500 uppercase">{{ t('label_title', lang) }}</span>
                    <span class="text-lg">{{ job.title }}</span>
                </div>
                <div>
                    <span class="block text-xs font-bold text-gray-500 uppercase">{{ t('label_type', lang) }}</span>
                    <span>{{ job.job_type.capitalize() }}</span>
                </div>
                <div class="col-span-2">
                    <span class="block text-xs font-bold text-gray-500 uppercase">{{ t('label_description', lang)
                        }}</span>
                    <p class="text-gray-700 whitespace-pre-line">{{ job.description or '-' }}</p>
                </div>
            </div>
        </div>

        <!-- Customer & Location -->
        <div class="mb-6 grid grid-cols-2 gap-8">
            <div>
                <h3 class="text-lg font-bold border-b border-gray-300 mb-2 uppercase">{{ t('col_customer', lang) }}</h3>
                <div class="space-y-2">
                    <p><i class="fas fa-user w-6 text-gray-400"></i> {{ job.customer_name }}</p>
                    <p><i class="fas fa-phone w-6 text-gray-400"></i> {{ job.customer_phone }}</p>
                    <p><i class="fas fa-map-marker-alt w-6 text-gray-400"></i> {{ job.customer_address }}</p>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-bold border-b border-gray-300 mb-2 uppercase">{{ t('col_schedule', lang) }}</h3>
                <div class="space-y-2">
                    <p><i class="fas fa-calendar w-6 text-gray-400"></i> {{ job.scheduled_date.strftime('%d/%m/%Y') }}
                    </p>
                    <p><i class="fas fa-clock w-6 text-gray-400"></i> {{ job.scheduled_time or 'Anytime' }}</p>
                </div>
            </div>
        </div>

        <!-- Product Details -->
        {% if job.product_type or job.model or job.serial_number %}
        <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
            <h3 class="text-sm font-bold text-gray-500 uppercase mb-2">Product/Equipment Details</h3>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <span class="block text-xs text-gray-500">{{ t('label_product_type', lang) }}</span>
                    <span class="font-medium">{{ job.product_type or '-' }}</span>
                </div>
                <div>
                    <span class="block text-xs text-gray-500">{{ t('label_model', lang) }}</span>
                    <span class="font-medium">{{ job.model or '-' }}</span>
                </div>
                <div>
                    <span class="block text-xs text-gray-500">{{ t('label_serial', lang) }}</span>
                    <span class="font-medium font-mono">{{ job.serial_number or '-' }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Assignments -->
        <div class="mb-8">
            <h3 class="text-lg font-bold border-b border-gray-300 mb-2 uppercase">{{ t('label_assign', lang) }}</h3>
            <div class="flex flex-wrap gap-2">
                {% if job.assignments %}
                {% for assign in job.assignments %}
                <span class="px-3 py-1 bg-gray-100 rounded border border-gray-300 text-sm">
                    {{ assign.technician.full_name if assign.technician else 'Unknown' }}
                </span>
                {% endfor %}
                {% else %}
                <span class="text-gray-400 italic">{{ t('label_unassigned', lang) }}</span>
                {% endif %}
            </div>
        </div>

        <!-- History Logs -->
        {% if job.history_logs %}
        <div class="mb-8">
            <h3 class="text-lg font-bold border-b border-gray-300 mb-4 uppercase">{{ t('header_history', lang) }}</h3>
            <div class="space-y-3">
                {% for log in job.history_logs|sort(attribute='created_at', reverse=True) %}
                <div class="flex gap-4 text-sm break-inside-avoid">
                    <div class="w-32 flex-shrink-0 text-gray-500 text-xs text-right pt-1">
                        {{ log.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    <div class="flex-1 border-l-2 border-gray-200 pl-4 pb-1 relative">
                        <!-- Timeline Dot -->
                        <div
                            class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full bg-white border-2 border-gray-300">
                        </div>

                        <div class="font-bold text-gray-800">
                            {{ log.user.full_name if log.user else 'System' }}
                            {% if log.new_status and log.new_status != log.old_status %}
                            <span class="font-normal text-gray-500 mx-1">changed status to</span>
                            <span
                                class="inline-block px-2 py-0.5 rounded text-xs uppercase bg-gray-100 border border-gray-200">
                                {{ log.new_status }}
                            </span>
                            {% endif %}
                        </div>
                        {% if log.note %}
                        <div class="text-gray-600 mt-1 bg-gray-50 p-2 rounded border border-gray-100 inline-block">
                            {{ log.note }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Signature Area -->
        <div class="grid grid-cols-2 gap-12 mt-12 pt-12 border-t border-gray-200 break-inside-avoid">
            <div class="text-center">
                <div class="h-20 border-b border-gray-400 mb-2"></div>
                <p class="text-sm font-bold">Technician Signature</p>
            </div>
            <div class="text-center">
                <div class="h-20 border-b border-gray-400 mb-2"></div>
                <p class="text-sm font-bold">Customer Signature</p>
                <p class="text-xs text-gray-500">I certify that the work has been completed.</p>
            </div>
        </div>

        <!-- Print Button (Hidden in Print) -->
        <div class="fixed bottom-8 right-8 no-print">
            <button onclick="window.print()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2">
                <i class="fas fa-print"></i> Print / Save PDF
            </button>
        </div>

    </div>

</body>

</html>